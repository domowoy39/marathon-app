<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ú–∞—Ä–∞—Ñ–æ–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-green: #2ecc71;
            --accent-yellow: #f1c40f;
            --accent-red: #e74c3c;
            --grid-gap: 8px;
            --radius: 12px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow-x: hidden; min-height: 100vh; }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #selection-overlay { position: fixed; inset: 0; background: var(--bg-color); z-index: 100; padding: 20px; display: flex; flex-direction: column; justify-content: center; }
        .select-header { text-align: center; margin-bottom: 30px; }
        .select-header h1 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .select-header p { color: var(--text-secondary); margin-top: 8px; font-size: 15px; }

        .difficulty-card { padding: 24px 20px; margin-bottom: 12px; border-radius: 16px; cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden; background: #1e1e1e; border: 1px solid rgba(255,255,255,0.08); }
        .difficulty-card:active { transform: scale(0.96); }
        
        .diff-light { border-left: 4px solid var(--accent-green); }
        .diff-mid { border-left: 4px solid var(--accent-yellow); }
        .diff-hard { border-left: 4px solid var(--accent-red); }

        .diff-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; color: var(--text-secondary); }
        .diff-amount { font-size: 28px; font-weight: 800; margin-bottom: 4px; color: #fff; }
        .diff-desc { font-size: 13px; opacity: 0.6; }

        #app-container { padding: 16px; max-width: 500px; margin: 0 auto; padding-bottom: 40px; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .level-badge { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; background: #252525; display: flex; align-items: center; gap: 6px; }
        .settings-btn { background: none; border: none; color: var(--text-secondary); padding: 8px; cursor: pointer; opacity: 0.7; }

        .progress-section { text-align: center; margin-bottom: 30px; position: relative; padding: 20px; background: #1e1e1e; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .total-display { font-size: 42px; font-weight: 900; line-height: 1; margin-bottom: 8px; letter-spacing: -1px; }
        .total-label { color: var(--text-secondary); font-size: 14px; margin-bottom: 16px; }
        
        .progress-track { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .fill-green { background: var(--accent-green); }
        .fill-yellow { background: var(--accent-yellow); }
        .fill-red { background: var(--accent-red); }

        .calendar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        
        .day-cell { 
            aspect-ratio: 1; background: #252525; border-radius: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: all 0.15s; 
        }
        .day-cell:active { transform: scale(0.9); }
        
        .day-cell.today { box-shadow: inset 0 0 0 2px var(--accent-yellow); }
        .day-cell.completed { background: #fff; color: #000; }
        
        .day-number { font-size: 10px; position: absolute; top: 4px; left: 6px; opacity: 0.5; }
        .day-amount { font-size: 13px; font-weight: 700; }

        #loader { position: fixed; inset: 0; background: var(--bg-color); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <div id="selection-overlay" class="hidden">
        <div class="select-header">
            <h1 id="month-title">...</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –Ω–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>
        </div>
        <div class="difficulty-card diff-light" onclick="selectLevel(0)">
            <div class="diff-title" style="color:var(--accent-green)">üü¢ –õ–∞–π—Ç</div>
            <div class="diff-amount" id="amount-0">...</div>
            <div class="diff-desc">–°–ø–æ–∫–æ–π–Ω—ã–π —Ç–µ–º–ø –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞</div>
        </div>
        <div class="difficulty-card diff-mid" onclick="selectLevel(1)">
            <div class="diff-title" style="color:var(--accent-yellow)">üü° –ü—Ä–æ–≥—Ä–µ—Å—Å</div>
            <div class="diff-amount" id="amount-1">...</div>
            <div class="diff-desc">–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (–†–µ–∫–æ–º–µ–Ω–¥—É—é)</div>
        </div>
        <div class="difficulty-card diff-hard" onclick="selectLevel(2)">
            <div class="diff-title" style="color:var(--accent-red)">üî¥ –í—ã–∑–æ–≤</div>
            <div class="diff-amount" id="amount-2">...</div>
            <div class="diff-desc">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ</div>
        </div>
    </div>

    <div id="app-container" class="hidden fade-in">
        <div class="top-bar">
            <div class="level-badge" id="level-badge"></div>
            <button class="settings-btn" onclick="resetProgress()">‚öôÔ∏è –°–±—Ä–æ—Å</button>
        </div>

        <div class="progress-section">
            <div class="total-display" id="total-saved">0</div>
            <div class="total-label">–Ω–∞–∫–æ–ø–ª–µ–Ω–æ –∏–∑ <span id="goal-total">0</span> ‚ÇΩ</div>
            <div class="progress-track">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
        </div>

        <div class="calendar-grid" id="calendar"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const GOALS = {
            0: [1000, 2000, 5000], 1: [2000, 4000, 10000], 2: [3000, 7000, 20000],
            3: [4000, 10000, 30000], 4: [5000, 15000, 45000], 5: [6000, 20000, 60000],
            6: [7000, 25000, 75000], 7: [8000, 30000, 90000], 8: [9000, 35000, 105000],
            9: [10000, 40000, 120000], 10: [11000, 45000, 135000], 11: [12000, 50000, 150000]
        };
        const MONTHS = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];

        let curYear, curMonth, daysInMonth, storageKey, appData;

        function generateBalancedAmounts(total, days) {
            let amounts = [];
            let remaining = total;
            let avg = Math.floor(total / days);
            
            for(let i=0; i<days-1; i++) {
                let variation = Math.floor(avg * 0.4); 
                let val = Math.floor(Math.random() * (variation * 2 + 1)) + (avg - variation);
                
                if(avg > 50) val = Math.round(val / 10) * 10;
                
                if(val < 10) val = 10;
                amounts.push(val);
                remaining -= val;
            }
            
            amounts.push(remaining);

            if (remaining < 10 || remaining > avg * 3) {
                return generateBalancedAmounts(total, days);
            }

            return amounts.sort(() => Math.random() - 0.5);
        }

        async function init() {
            const d = new Date();
            curYear = d.getFullYear();
            curMonth = d.getMonth();
            daysInMonth = new Date(curYear, curMonth + 1, 0).getDate();
            storageKey = `marathon_v1_${curYear}_${curMonth}`;
            
            document.getElementById('month-title').innerText = MONTHS[curMonth];

            tg.CloudStorage.getItem(storageKey, (err, val) => {
                document.getElementById('loader').classList.add('hidden');
                if(!err && val) {
                    appData = JSON.parse(val);
                    showApp();
                } else {
                    const local = localStorage.getItem(storageKey);
                    if(local) { appData = JSON.parse(local); showApp(); }
                    else showSelect();
                }
            });
        }

        function showSelect() {
            const g = GOALS[curMonth];
            [0,1,2].forEach(i => document.getElementById(`amount-${i}`).innerText = g[i].toLocaleString() + ' ‚ÇΩ');
            document.getElementById('selection-overlay').classList.remove('hidden');
        }

        function selectLevel(lvl) {
            const total = GOALS[curMonth][lvl];
            appData = {
                level: lvl,
                amounts: generateBalancedAmounts(total, daysInMonth),
                completed: new Array(daysInMonth).fill(false)
            };
            save();
            document.getElementById('selection-overlay').classList.add('hidden');
            showApp();
        }

        function showApp() {
            document.getElementById('app-container').classList.remove('hidden');
            const colors = ['#2ecc71', '#f1c40f', '#e74c3c'];
            const names = ['üü¢ –õ–∞–π—Ç', 'üü° –ü—Ä–æ–≥—Ä–µ—Å—Å', 'üî¥ –í—ã–∑–æ–≤'];
            const classes = ['fill-green', 'fill-yellow', 'fill-red'];
            
            const badge = document.getElementById('level-badge');
            badge.innerText = names[appData.level];
            badge.style.color = colors[appData.level];
            
            document.getElementById('progress-bar').className = `progress-fill ${classes[appData.level]}`;
            document.getElementById('goal-total').innerText = GOALS[curMonth][appData.level].toLocaleString();

            renderGrid();
            updateUI();
        }

        function renderGrid() {
            const grid = document.getElementById('calendar');
            grid.innerHTML = '';
            const today = new Date().getDate();

            appData.amounts.forEach((amt, i) => {
                const el = document.createElement('div');
                el.className = `day-cell ${appData.completed[i] ? 'completed' : ''} ${i+1 === today ? 'today' : ''}`;
                el.innerHTML = `<div class="day-number">${i+1}</div><div class="day-amount">${amt}</div>`;
                el.onclick = () => toggle(i);
                grid.appendChild(el);
            });
        }

        function toggle(i) {
            tg.HapticFeedback.impactOccurred('light');
            appData.completed[i] = !appData.completed[i];
            save();
            renderGrid();
            UI();
        }

        function updateUI() {
            let sum = 0;
            appData.amounts.forEach((a, i) => { if(appData.completed[i]) sum += a; });
            const total = GOALS[curMonth][appData.level];
            
            document.getElementById('total-saved').innerText = sum.toLocaleString();
            document.getElementById('progress-bar').style.width = (sum/total*100) + '%';
            
            if(sum >= total) {
                tg.MainButton.setText("üéâ –¶–µ–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!");
                tg.MainButton.show();
                tg.MainButton.color = "#2ecc71";
            } else {
                tg.MainButton.hide();
            }
        }

        function save() {
            const str = JSON.stringify(appData);
            tg.CloudStorage.setItem(storageKey, str);
            localStorage.setItem(storageKey, str);
        }

        function resetProgress() {
            tg.showConfirm("–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –≤—ã–±—Ä–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –∑–∞–Ω–æ–≤–æ?", (ok) => {
                if(ok) {
                    localStorage.removeItem(storageKey);
                    tg.CloudStorage.removeItem(storageKey);
                    location.reload();
                }
            });
        }

        init();
    </script>
</body>
</html>
